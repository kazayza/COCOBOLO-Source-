Option Compare Database


Option Explicit

Private Sub cmdsave_Click()
    On Error GoTo ErrorHandler
    
    Dim db As DAO.Database
    Dim rs As DAO.Recordset
    
    ' التحقق من إدخال اسم الصلاحية
    If IsNull(Me.txtPermissionName) Or Trim(Me.txtPermissionName) = "" Then
        MsgBox "يجب إدخال اسم الصلاحية", vbExclamation, "بيانات ناقصة"
        Me.txtPermissionName.SetFocus
        Exit Sub
    End If
    
    ' التحقق من عدم تكرار اسم الصلاحية
    Set db = CurrentDb
   Set rs = db.OpenRecordset("SELECT PermissionID FROM dbo_Permissions " & _
       "WHERE PermissionName = '" & Replace(Me.txtPermissionName, "'", "''") & "'", _
       dbOpenSnapshot, dbSeeChanges)
    
    If Not rs.EOF Then
        MsgBox "اسم الصلاحية موجود مسبقاً", vbExclamation, "خطأ في البيانات"
        Me.txtPermissionName.SetFocus
        GoTo CleanExit
    End If
    
    ' فتح Recordset للإضافة
    Set rs = db.OpenRecordset("dbo_Permissions", dbOpenDynaset, dbSeeChanges)
    
    ' إضافة سجل جديد
    rs.AddNew
    rs!PermissionName = Me.txtPermissionName
    rs!Description = Nz(Me.txtDescription, Null)
    rs!Category = Nz(Me.cboCategory, "")
    rs!FormName = Nz(Me.txtFormName, "")
    rs!CreatedBy = currentUser.UserName
    rs!CreatedAt = Now()
    rs.Update
    
    MsgBox "تمت إضافة الصلاحية الجديدة بنجاح", vbInformation, "نجاح"
    
    ' تنظيف النموذج
    Me.txtPermissionName = ""
    Me.txtDescription = ""
    Me.cboCategory = Null
    Me.txtFormName = Null
    Me.txtPermissionName.SetFocus

CleanExit:
    If Not rs Is Nothing Then
        rs.Close
        Set rs = Nothing
    End If
    Set db = Nothing
    Exit Sub
    
ErrorHandler:
    MsgBox "حدث خطأ أثناء حفظ الصلاحية: " & Err.Description & vbCrLf & _
           "رقم الخطأ: " & Err.Number, vbCritical, "خطأ"
    Resume CleanExit
End Sub

Private Sub cmdCancel_Click()
    DoCmd.Close acForm, Me.Name
End Sub

Private Sub Form_Open(Cancel As Integer)
 If Not currentUser.HasPermission(Me.Name) Then
        Cancel = True
        MsgBox "غير مصرح لك بالدخول", vbExclamation
        DoCmd.Close acForm, Me.Name
    End If
End Sub