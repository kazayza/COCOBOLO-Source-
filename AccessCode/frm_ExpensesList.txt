Option Compare Database

Private Sub btnAddExpense_Click()
DoCmd.OpenForm "frm_Expenses"
End Sub

Private Sub btnAddExpensesGroup_Click()
DoCmd.OpenForm "frm_ExpensesGroup"
End Sub

Private Sub btnClearSearch_Click()

    ' مسح الفلاتر
    Me.txtSearch = Null
    Me.txtDateFrom = Null
    Me.txtDateTo = Null
    Me.cbomaingroup = Null
    Me.cboexpense = Null
    
    ' عرض كل البيانات من غير شروط
    Me.RecordSource = "SELECT e.ExpenseID, eg.ExpenseGroupName, pg.ExpenseGroupName AS ParentGroupName, " & _
                      "e.ExpenseDate, e.Amount, cb.CashBoxName, e.Notes, e.CreatedBy, e.CreatedAt " & _
                      "FROM ((dbo_Expenses AS e " & _
                      "INNER JOIN dbo_ExpenseGroups AS eg ON e.ExpenseGroupID = eg.ExpenseGroupID) " & _
                      "LEFT JOIN dbo_ExpenseGroups AS pg ON eg.ParentGroupID = pg.ExpenseGroupID) " & _
                      "INNER JOIN dbo_CashBoxes AS cb ON e.CashBoxID = cb.CashBoxID " & _
                      "ORDER BY e.ExpenseDate DESC;"
    
    Me.Requery


End Sub

Private Sub btnOpen_Click()
    Dim expID As Long
    expID = Me.ExpenseID  ' معرف المصروف الحالي

    If expID = 0 Then
        MsgBox "اختر مصروف أولاً.", vbExclamation
        Exit Sub
    End If

    ' افتح الفورم الغير مربوط، ومرر EexpenseID باستخدام OpenArgs
    DoCmd.OpenForm "frm_Expenses", , , , , , expID
End Sub


Private Sub btnOpenReport_Click()
    On Error GoTo ErrorHandler
   
    
    ' فتح التقرير مع معايير البحث الحالية
    DoCmd.OpenReport "rptExpensesReport", acViewPreview
    
    Exit Sub
    
ErrorHandler:
    MsgBox "حدث خطأ أثناء فتح التقرير: " & Err.Description, vbCritical
End Sub



Private Sub btnRefresh_Click()
Me.Requery
 Me.RecordSource = "SELECT e.ExpenseID, eg.ExpenseGroupName, pg.ExpenseGroupName AS ParentGroupName, " & _
                      "e.ExpenseDate, e.Amount, cb.CashBoxName, e.Notes, e.CreatedBy, e.CreatedAt " & _
                      "FROM ((dbo_Expenses AS e " & _
                      "INNER JOIN dbo_ExpenseGroups AS eg ON e.ExpenseGroupID = eg.ExpenseGroupID) " & _
                      "LEFT JOIN dbo_ExpenseGroups AS pg ON eg.ParentGroupID = pg.ExpenseGroupID) " & _
                      "INNER JOIN dbo_CashBoxes AS cb ON e.CashBoxID = cb.CashBoxID " & _
                      "ORDER BY e.ExpenseDate DESC;"
End Sub


Private Sub ApplyExpenseFilter()
    Dim strSQL As String
    Dim strWhere As String
    
    ' الاستعلام الأساسي
    strSQL = "SELECT e.ExpenseID, eg.ExpenseGroupName, pg.ExpenseGroupName AS ParentGroupName, " & _
             "e.ExpenseDate, e.Amount, cb.CashBoxName, e.Notes, e.CreatedBy, e.CreatedAt " & _
             "FROM ((dbo_Expenses AS e " & _
             "INNER JOIN dbo_ExpenseGroups AS eg ON e.ExpenseGroupID = eg.ExpenseGroupID) " & _
             "LEFT JOIN dbo_ExpenseGroups AS pg ON eg.ParentGroupID = pg.ExpenseGroupID) " & _
             "INNER JOIN dbo_CashBoxes AS cb ON e.CashBoxID = cb.CashBoxID "
             
    ' بناء شروط البحث
    strWhere = ""
    
    ' بحث نصي
    If Nz(Me.txtSearch, "") <> "" Then
        strWhere = strWhere & " (e.ExpenseName LIKE '*" & Me.txtSearch & "*' " & _
                              "OR e.Notes LIKE '*" & Me.txtSearch & "*') AND"
    End If
    
    ' فلترة بتاريخ من
    If Not IsNull(Me.txtDateFrom) Then
        strWhere = strWhere & " e.ExpenseDate >= #" & Format(Me.txtDateFrom, "yyyy-mm-dd") & "# AND"
    End If
    
    ' فلترة بتاريخ إلى
    If Not IsNull(Me.txtDateTo) Then
        strWhere = strWhere & " e.ExpenseDate <= #" & Format(Me.txtDateTo, "yyyy-mm-dd") & "# AND"
    End If
    
    ' إزالة AND الأخير لو موجود
    If Right(strWhere, 3) = "AND" Then
        strWhere = Left(strWhere, Len(strWhere) - 3)
    End If
    
    ' إضافة WHERE إذا فيه شروط
    If strWhere <> "" Then
        strSQL = strSQL & " WHERE " & strWhere
    End If
    
    ' ترتيب النتائج
    strSQL = strSQL & " ORDER BY e.ExpenseDate DESC;"
    
    ' تطبيق الاستعلام على الفورم
    Me.RecordSource = strSQL
    Me.Requery
End Sub



Private Sub btnSearch_Click()
ApplyExpenseFilter
End Sub

Private Sub cboexpense_AfterUpdate()
Me.txtSearch = Me.cboexpense.Column(1)
ApplyExpenseFilter
End Sub

Private Sub cbomaingroup_AfterUpdate()
Me.cboexpense.Requery
End Sub


' زر التصدير لإكسل
Private Sub btnExportExcel_Click()
    On Error GoTo ErrorHandler
    
   
    
    ' تصدير الاستعلام إلى Excel
    Dim exportPath As String
    exportPath = CurrentProject.Path & "\تقرير_المصروفات_" & Format(Now(), "yyyy-mm-dd_hh-mm") & ".xlsx"
    
    DoCmd.TransferSpreadsheet acExport, acSpreadsheetTypeExcel12Xml, "qryExpensesReport2", exportPath, True
    
    MsgBox "تم التصدير بنجاح إلى: " & exportPath, vbInformation
    
    Exit Sub
    
ErrorHandler:
    MsgBox "حدث خطأ أثناء التصدير: " & Err.Description, vbCritical

End Sub

Private Sub Command81_Click()
   On Error GoTo ErrorHandler
   
    
    ' فتح التقرير مع معايير البحث الحالية
    DoCmd.OpenReport "rpt_AdvansedExpenseNew", acViewPreview
    
    Exit Sub
    
ErrorHandler:
    MsgBox "حدث خطأ أثناء فتح التقرير: " & Err.Description, vbCritical
End Sub

Private Sub Form_Load()
Me.Requery
End Sub

Private Sub Form_Open(Cancel As Integer)

    If Not currentUser.HasPermission(Me.Name, "View") Then
        MsgBox "ليس لديك صلاحية لعرض هذه الشاشة.", vbExclamation
        Cancel = True
        Exit Sub
    End If

End Sub
