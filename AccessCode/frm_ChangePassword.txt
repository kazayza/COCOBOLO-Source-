Option Compare Database

Private Sub btnChangePassword_Click()

    Dim db As DAO.Database
    Dim rs As DAO.Recordset
    Dim strSQL As String
    Dim UserId As Long   ' أو اسم المستخدم حسب نظامك
    Dim oldPass As String, newPass As String, confirmPass As String

    On Error GoTo ErrHandler

    ' اجمع البيانات من الفورم
    oldPass = Nz(Me.txtOldPassword.value, "")
    newPass = Nz(Me.txtNewPassword.value, "")
    confirmPass = Nz(Me.txtConfirmPassword.value, "")
    UserId = currentUser.UserId 'Nz(Me.txtUserID.Value, 0)  ' أو لو عندك متغير جلسة UserID

    ' تحقق من إدخال الحقول
    If oldPass = "" Or newPass = "" Or confirmPass = "" Then
        MsgBox "من فضلك أدخل جميع الحقول.", vbExclamation
        Exit Sub
    End If

    ' تحقق أن الجديد = إعادة الجديد
    If newPass <> confirmPass Then
        MsgBox "كلمة السر الجديدة غير متطابقة.", vbCritical
        Exit Sub
    End If

    ' افتح جدول المستخدمين وتحقق من الباسورد القديم
    strSQL = "SELECT * FROM dbo_Users WHERE UserID=" & UserId
    Set db = CurrentDb
    Set rs = db.OpenRecordset(strSQL, dbOpenDynaset, dbSeeChanges)

    If rs.EOF Then
        MsgBox "المستخدم غير موجود.", vbCritical
        Exit Sub
    End If

    If rs!Password <> oldPass Then
        MsgBox "كلمة السر القديمة غير صحيحة.", vbCritical
        Exit Sub
    End If

    ' حدّث الباسورد
    rs.Edit
    rs!Password = newPass
    rs.Update

    MsgBox "تم تغيير كلمة السر بنجاح.", vbInformation
    Me.txtOldPassword = ""
    Me.txtNewPassword = ""
    Me.txtConfirmPassword = ""
    rs.Close
    Set rs = Nothing
    Set db = Nothing
    Exit Sub

ErrHandler:
    MsgBox "حدث خطأ: " & Err.Description, vbCritical

End Sub

